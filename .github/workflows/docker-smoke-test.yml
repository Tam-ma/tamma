# =============================================================================
# Docker Smoke Test
#
# After images are built on main, spins up the full Docker Compose stack and
# verifies that core services respond to health checks.
# =============================================================================

name: Docker Smoke Test

on:
  workflow_run:
    workflows: ["Build & Publish Docker Images"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  packages: read

jobs:
  smoke-test:
    name: Full Stack Smoke Test
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Build all images locally
        working-directory: docker
        run: |
          docker compose build
        env:
          COMPOSE_FILE: docker-compose.yml

      - name: Start stack
        working-directory: docker
        run: |
          cp .env.example .env
          # Override required secrets with test values
          echo "POSTGRES_PASSWORD=testpass123" >> .env
          echo "GITHUB_TOKEN=ghp_test_token" >> .env
          echo "ANTHROPIC_API_KEY=sk-ant-test-key" >> .env
          echo "GITHUB_OWNER=test-org" >> .env
          echo "GITHUB_REPO=test-repo" >> .env
          docker compose up -d

      - name: Wait for health checks
        timeout-minutes: 5
        run: |
          echo "Waiting for services to become healthy..."
          for service in postgres rabbitmq tamma-api tamma-dashboard; do
            echo "Waiting for $service..."
            timeout 120 bash -c "until docker compose -f docker/docker-compose.yml ps $service | grep -q healthy; do sleep 5; done" || true
          done
          docker compose -f docker/docker-compose.yml ps

      - name: Test health endpoints
        run: |
          # Test TS API health
          curl -sf http://localhost:3100/health || echo "tamma-api health check pending"
          # Test dashboard
          curl -sf http://localhost:3001/ || echo "dashboard health check pending"

      - name: Collect logs on failure
        if: failure()
        working-directory: docker
        run: |
          docker compose logs --tail=100

      - name: Teardown
        if: always()
        working-directory: docker
        run: docker compose down -v
